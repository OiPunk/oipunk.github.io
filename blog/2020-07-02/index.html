<!DOCTYPE html><html lang="en"> <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Distributed Transaction Solutions</title><meta name="description" content="Java Backend Engineer specializing in Spring Boot, distributed systems, and microservices. Explore my projects, technical blog, and expertise."><meta name="keywords" content="Java, Spring Boot, Backend Developer, Microservices, Distributed Systems, MySQL, Redis, Docker, Kubernetes"><meta name="author" content="Weiguang Li"><meta name="robots" content="index, follow"><link rel="canonical" href="https://oipunk.github.io/portfolio"><!-- Open Graph --><meta property="og:type" content="website"><meta property="og:url" content="https://oipunk.github.io/portfolio"><meta property="og:title" content="Distributed Transaction Solutions"><meta property="og:description" content="Java Backend Engineer specializing in Spring Boot, distributed systems, and microservices. Explore my projects, technical blog, and expertise."><meta property="og:image" content="https://oipunk.github.io/portfolio/img/og-image.jpg"><!-- Twitter Card --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:title" content="Distributed Transaction Solutions"><meta name="twitter:description" content="Java Backend Engineer specializing in Spring Boot, distributed systems, and microservices. Explore my projects, technical blog, and expertise."><meta name="twitter:image" content="https://oipunk.github.io/portfolio/img/og-image.jpg"><link rel="shortcut icon" type="image/x-icon" href="/portfolio/img/favicon.png"><link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;700&family=Inter:wght@300;400;700;900&display=swap" rel="stylesheet"><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet"><!-- Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=G-DNX03VZHBX"></script><script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-DNX03VZHBX');
    </script><link rel="stylesheet" href="/_astro/about.Bxf0nmK-.css"></head> <body class="bg-gray-950 text-gray-100 font-sans"> <header class="sticky top-0 z-50 bg-gray-950/95 backdrop-blur-sm border-b border-gray-800" x-data="{ open: false, scrolled: false }" @scroll.window="scrolled = window.scrollY > 50"> <nav class="max-w-6xl mx-auto px-6 lg:px-12 py-6 flex items-center justify-between"> <a href="/" class="flex items-center gap-2 "> <i class="fas fa-code text-green-400 text-2xl led-glow"></i> <span class="text-xl font-bold font-code text-white">Weiguang Li</span> </a> <div class="hidden md:flex items-center gap-10 main-nav"> <a href="/about" class="group relative text-gray-300 hover:text-green-400 transition-colors font-medium  ">  About </a><a href="/projects" class="group relative text-gray-300 hover:text-green-400 transition-colors font-medium  ">  Projects </a><a href="/services" class="group relative text-gray-300 hover:text-green-400 transition-colors font-medium  ">  Expertise </a><a href="/blog" class="group relative text-gray-300 hover:text-green-400 transition-colors font-medium  ">  Blog </a><a href="/contact" class="group relative text-gray-300 hover:text-green-400 transition-colors font-medium  ">  Contact </a> </div> <div class="md:hidden"> <button @click="open = !open" class="text-gray-300 hover:text-green-400 transition-colors"> <i x-show="!open" style="display: none;" class="fas fa-bars text-2xl"></i> <i x-show="open" class="fas fa-times text-2xl"></i> </button> <div x-show="open" style="display: none;" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 -translate-y-2" x-transition:enter-end="opacity-100 translate-y-0" x-transition:leave="transition ease-in duration-200" x-transition:leave-start="opacity-100 translate-y-0" x-transition:leave-end="opacity-0 -translate-y-2" class="absolute top-full left-0 right-0 bg-gray-950 border-b border-gray-800 p-6 flex flex-col gap-4 shadow-lg"> <a href="/about" class="group relative text-gray-300 hover:text-green-400 transition-colors font-medium  " x-on:click="open = false">  About </a><a href="/projects" class="group relative text-gray-300 hover:text-green-400 transition-colors font-medium  " x-on:click="open = false">  Projects </a><a href="/services" class="group relative text-gray-300 hover:text-green-400 transition-colors font-medium  " x-on:click="open = false">  Expertise </a><a href="/blog" class="group relative text-gray-300 hover:text-green-400 transition-colors font-medium  " x-on:click="open = false">  Blog </a><a href="/contact" class="group relative text-gray-300 hover:text-green-400 transition-colors font-medium  " x-on:click="open = false">  Contact </a> </div> </div> </nav> </header> <main id="main" class="relative bg-gray-900/50 overflow-hidden">  <section class="py-12 max-w-6xl mx-auto px-6 lg:px-12 relative z-10"> <div class="mb-8"> <h1 class="text-3xl lg:text-4xl font-bold font-code text-white mb-2"> <span class="text-white ">Distributed Transaction </span><span class="text-green-500 ">Solutions</span> </h1> <div class="flex items-center gap-4 text-gray-400"> <i class="fas fa-calendar-alt"></i> <span>July 2, 2020</span> <span>|</span> <span>44 min read</span> </div> </div> <div class="py-8 px-6 bg-gray-950 rounded-lg border border-gray-800 mb-8"> <div class="relative mb-8"> <img src="/portfolio/img/blog5.jpg" alt="Distributed Transaction Solutions" class="w-full object-cover rounded-lg border border-gray-800"> </div> <div class="post-content text-gray-300 space-y-8"><p><h1>分布式事务</h1></p><p><strong>事务（Transaction）</strong>-一般是指要做的或所做的事情-由<strong>事务开始(begin transaction)</strong>和<strong>事务结束(end transaction)</strong>之间执行的全体操作组成。</p><p><strong>简单的讲就是-要么全部被执行-要么就全部失败。</strong></p><p>那<strong>分布式事务</strong>-自然就是运行在分布式系统中的事务-是由<strong>多个不同的机器上的事务组合而成</strong>的。同上-只有分布式系统中所有事务执行了才能是成功-否则失败。</p><p>事务的基本特征ACID：</p><p><li>原子性（Atomicity）</li>
  - 一个事务是一个不可分割的工作单位-事务中包括的诸操作要么都做-要么都不做。
<li>一致性</li>
  - 指事务执行前和执行后-数据是完整的。
<li>隔离性</li>
  - 一个事务的执行不能被其他事务干扰。即一个事务内部的操作及使用的数据对并发的其他事务是隔离的-并发执行的各个事务之间不能互相干扰。
<li>持久性</li>
  - 也称为永久性-一个事务一旦提交-它对数据库中数据的改变就应该是永久性的保存下来了。</p><p>---</p><p><strong>分布式事务的目标：解决多个独立事务一致性的问题。</strong></p><p>我们遇到的问题：</p><p>分布式事务：一个功能-横跨多个微服务-由于每个微服务不在一个库-没法用数据库事务来保证事务。</p><p>网约车例子：乘客支付订单。支付系统中-支付表更新-订单系统-订单库 订单状态更新为已支付。</p><p>订单-支付表-在不同的库-如何保证两个库之间的事务。</p><p>支付操作：支付修改余额-修改订单状态。</p><p><h2>分布式事务解决方案</h2></p><p><h3>二阶段提交协议</h3></p><p>基于XA协议的-采取强一致性-遵从ACID.</p><p>2PC：（2阶段提交协议）-是基于XA/JTA规范。</p><p>#### XA</p><p>XA是由X/Open组织提出的分布式事务的架构（或者叫协议）。XA架构主要定义了（全局）事务管理器（Transaction Manager）和（局部）资源管理器（Resource Manager）之间的接口。XA接口是双向的系统接口-在事务管理器（Transaction Manager）以及一个或多个资源管理器（Resource Manager）之间形成通信桥梁。也就是说-在基于XA的一个事务中-我们可以针对多个资源进行事务管理-例如一个系统访问多个数据库-或即访问数据库、又访问像消息中间件这样的资源。这样我们就能够实现在多个数据库和消息中间件直接实现全部提交、或全部取消的事务。XA规范不是java的规范-而是一种通用的规范。</p><p>#### JTA</p><p>JTA(Java Transaction API)-是J2EE的编程接口规范-它是XA协议的JAVA实现。它主要定义了：</p><p>一个事务管理器的接口javax.transaction.TransactionManager-定义了有关事务的开始、提交、撤回等操作。  
一个满足XA规范的资源定义接口javax.transaction.xa.XAResource-一种资源如果要支持JTA事务-就需要让它的资源实现该XAResource接口-并实现该接口定义的两阶段提交相关的接口。</p><p>> 《二阶段提交协议》<img src="/images/blog/%E4%BA%8C%E9%98%B6%E6%AE%B5%E6%8F%90%E4%BA%A4%E5%8D%8F%E8%AE%AE.png" alt="illustration" class="my-4" /></p><p>#### 过程</p><p>``<code>sh
1.请求阶段（commit-request phase-或称表决阶段-voting phase）在请求阶段-协调者将通知事务参与者准备提交或取消事务-然后进入表决过程。在表决过程中-参与者将告知协调者自己的决策：同意（事务参与者本地作业执行成功）或取消（本地作业执行故障）。2.提交阶段（commit phase）在该阶段-协调者将基于第一个阶段的投票结果进行决策：提交或取消。当且仅当所有的参与者同意提交事务协调者才通知所有的参与者提交事务-否则协调者将通知所有的参与者取消事务。参与者在接收到协调者发来的消息后将执行响应的操作。
</code>`<code></p><p>#### 缺点：</p><p><li><strong>单点故障</strong>：事务的发起、提交还是取消-均是由老大协调者管理的-只要协调者宕机-那就凉凉了。</li>
<li><strong>同步阻塞缺点</strong>：从上面介绍以及例子可看出-我们的参与系统中在没收到老大的真正提交还是取消事务指令的时候-就是锁定当前的资源-并不真正的做些事务相关操作-所以-整个分布式系统环境就是阻塞的。</li>
<li><strong>数据不一致缺点</strong>：就是说在老大协调者向小弟们发送真正提交事务的时候-部分网路故障-造成部分系统没收到真正的指令-那么就会出现部分提交部分没提交-因此-这就会导致数据的不一致。</li></p><p>#### 无法解决的问题</p><p>当协调者出错-同时参与者也出错时-两阶段无法保证事务执行的完整性。  
考虑协调者再发出commit消息之后宕机-而唯一接收到这条消息的参与者同时也宕机了。  
那么即使有了新的协调者-这条事务的状态也是不确定的-没人知道事务是否被已经提交。知道的人已经被灭口了。</p><p><h3>三阶段提交协议</h3></p><p>采取强一致性-遵从ACID。</p><p>在二阶段上增加了：超时和预提交机制。</p><p>有这三个主阶段-canCommit、preCommit、doCommit这三个阶段</p><p>> 《三阶段提交协议》<img src="/images/blog/%E4%B8%89%E9%98%B6%E6%AE%B5%E6%8F%90%E4%BA%A4%E5%8D%8F%E8%AE%AE.png" alt="illustration" class="my-4" /></p><p>#### 流程</p><p></code>`<code>sh
1.CanCommit阶段3PC的CanCommit阶段其实和2PC的准备阶段很像。协调者向参与者发送commit请求-参与者如果可以提交就返回Yes响应-否则返回No响应。2.PreCommit阶段Coordinator根据Cohort的反应情况来决定是否可以继续事务的PreCommit操作。根据响应情况-有以下两种可能。A.假如Coordinator从所有的Cohort获得的反馈都是Yes响应-那么就会进行事务的预执行：发送预提交请求。Coordinator向Cohort发送PreCommit请求-并进入Prepared阶段。事务预提交。Cohort(一群大兵)接收到PreCommit请求后-会执行事务操作-并将undo和redo信息记录到事务日志中。响应反馈。如果Cohort成功的执行了事务操作-则返回ACK响应-同时开始等待最终指令。B.假如有任何一个Cohort向Coordinator发送了No响应-或者等待超时之后-Coordinator都没有接到Cohort的响应-那么就中断事务：发送中断请求。Coordinator向所有Cohort发送abort请求。中断事务。Cohort收到来自Coordinator的abort请求之后（或超时之后-仍未收到Cohort的请求）-执行事务的中断。3.DoCommit阶段该阶段进行真正的事务提交-也可以分为以下两种情况:执行提交A.发送提交请求。Coordinator接收到Cohort发送的ACK响应-那么他将从预提交状态进入到提交状态。并向所有Cohort发送doCommit请求。B.事务提交。Cohort接收到doCommit请求之后-执行正式的事务提交。并在完成事务提交之后释放所有事务资源。C.响应反馈。事务提交完之后-向Coordinator发送ACK响应。D.完成事务。Coordinator接收到所有Cohort的ACK响应之后-完成事务。中断事务协调者没有接收到参与者发送的ACK响应-那么就执行中断事务。A.发送中断请求协调者向所有参与者发送abort请求B.事务回滚参与者接收到abort请求之后-利用其在阶段二记录的undo信息来执行事务的回滚操作-并在完成回滚之后释放所有的事务资源。C.反馈结果参与者完成事务回滚之后-向协调者发送ACK消息D.中断事务协调者接收到参与者反馈的ACK消息之后-执行事务的中断。
</code>`<code></p><p>#### 缺点</p><p>如果进入PreCommit后-Coordinator发出的是abort请求-假设只有一个Cohort收到并进行了abort操作-  
而其他对于系统状态未知的Cohort会根据3PC选择继续Commit-此时系统状态发生不一致性。</p><p>#### 2和3 的区别</p><p>加了询问-增大成功概率。</p><p>对于协调者(Coordinator)和参与者(Cohort)都设置了超时机制（在2PC中-只有协调者拥有超时机制-即如果在一定时间内没有收到cohort的消息则默认失败）。协调者挂了-参与者等待超时后-默认提交事务。有一丢进步。</p><p>如果参与者异常了-协调者也异常了-会造成其他参与者提交。</p><p>在2PC的准备阶段和提交阶段之间-插入预提交阶段-使3PC拥有CanCommit、PreCommit、DoCommit三个阶段。  
PreCommit是一个缓冲-保证了在最后提交阶段之前各参与节点的状态是一致的。</p><p><h3>基于消息的最终一致性形式</h3></p><p>采取最终一致性-遵从BASE理论。</p><p><strong>BASE</strong>：全称是-Basically Avaliable（基本可用）-Soft state（软状态）-Eventually consistent（最终一致性）三个短语的缩写-来自eBay的架构师提出。</p><p><li><strong>Basically Avaliable：</strong>就是在分布式系统环境中-允许牺牲掉部分不影响主流程的功能的不可用-将其降级以确保核心服务的正常可用。</li>
<li><strong>Soft state：</strong>就是指在事务中-我们允许系统存在中间状态-且并不影响我们这个系统。就拿数据库的主从复制来说-是完全允许复制的时候有延时的发生的。</li>
<li><strong>Eventually consistent：</strong>还是以数据库主从复制为例说-虽然主从复制有小延迟-但是很快最终就数据保持一致了。</li></p><p>分布式事务不可能100%解决-只能提高成功概率。两阶段之间时间-毫秒级别。</p><p>补救措施：</p><p>定时任务补偿。程序或脚本补偿。</p><p>人工介入。</p><p><h3>TCC</h3></p><p>解决方案：TCC（Try、Confirm、Cancel）-两阶段补偿型方案。</p><p>从名字可以看出-实现一个事务-需要定义三个API：预先占有资源-确认提交实际操作资源-取消占有=回滚。</p><p>如果后两个环节执行一半失败了-记录日志-补偿处理-通知人工。</p><p></code>`<code>sh
2PC：是资源层面的分布式事务</div> </div> <div class="p-6 bg-gray-950 rounded-lg border border-gray-800 mb-8"> <div class="flex flex-col sm:flex-row items-center gap-6"> <img src="/portfolio/img/male2.jpg" alt="Weiguang Li" class="w-16 h-16 rounded-full object-cover"> <div> <h4 class="max-sm:text-center text-lg font-bold text-white mb-1">Weiguang Li</h4> <p class="text-gray-300 mb-3">Java Backend Engineer specializing in Spring Boot, distributed systems, and microservices. Passionate about clean code and continuous learning.</p> <div class="flex gap-4"> <a href="https://github.com/OiPunk" target="_blank" class="text-gray-300 hover:text-green-400 text-xl"> <i class="fab fa-github"></i> </a> <a href="https://linkedin.com/in/" target="_blank" class="text-gray-300 hover:text-green-400 text-xl"> <i class="fab fa-linkedin"></i> </a> <a href="https://twitter.com/" target="_blank" class="text-gray-300 hover:text-green-400 text-xl"> <i class="fab fa-twitter"></i> </a> </div> </div> </div> </div> <div class="relative"> <h3 class="text-xl font-bold font-code text-white mb-6 flex items-center gap-2"> <i class="fas fa-book text-green-400 led-glow"></i> Related Articles
</h3> <div class="grid grid-cols-1 gap-6"> <a href="/blog/2020-07-23" class="bg-gray-950 rounded-lg border border-gray-800 flex flex-col md:flex-row gap-4 related-card overflow-hidden transition-transform"> <img src="/portfolio/img/blog3.jpg" alt="Distributed Lock Solutions" class="w-full md:w-1/4 object-cover"> <div class="p-6 flex-1"> <h4 class="text-lg font-bold font-code text-white mb-1">Distributed Lock Solutions</h4> <p class="text-gray-300 text-sm">Implementing distributed locks using Redis and Zookeeper with comparison of different approaches and failure handling strategies.</p> <div class="flex items-center gap-2 text-gray-400 text-sm mt-2"> <i class="fas fa-calendar-alt"></i> <span>July 23, 2020</span> </div> </div> </a><a href="/blog/2020-06-23-spring-cloud-eurekaactuator" class="bg-gray-950 rounded-lg border border-gray-800 flex flex-col md:flex-row gap-4 related-card overflow-hidden transition-transform"> <img src="/portfolio/img/blog4.jpg" alt="Spring Cloud: Eureka &#38; Actuator Basics" class="w-full md:w-1/4 object-cover"> <div class="p-6 flex-1"> <h4 class="text-lg font-bold font-code text-white mb-1">Spring Cloud: Eureka &amp; Actuator Basics</h4> <p class="text-gray-300 text-sm">In-depth technical analysis with code examples and enterprise best practices.</p> <div class="flex items-center gap-2 text-gray-400 text-sm mt-2"> <i class="fas fa-calendar-alt"></i> <span>June 23, 2020</span> </div> </div> </a> </div> </div> </section>  </main> <footer class="bg-dark py-16 relative overflow-hidden"> <div class="absolute inset-0 bg-hero opacity-[.03]"></div> <div class="max-w-6xl mx-auto px-6 lg:px-12 relative"> <div class="grid grid-cols-1 md:grid-cols-4 gap-12"> <div class="md:col-span-2 flex flex-col items-center md:items-start"> <a href="/" class="flex items-center gap-2 mb-4"> <i class="fas fa-code text-green-400 text-2xl led-glow"></i> <span class="text-xl font-bold font-code text-white">Weiguang Li</span> </a> <p class="text-gray-400 text-left lg:pe-16"> Java Backend Engineer specializing in Spring Boot, distributed systems, and microservices. Passionate about open source and continuous learning. </p> <div class="flex gap-4 mt-4"> <a href="https://github.com/OiPunk" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-green-400 transition-colors"> <i class="fab fa-github text-2xl"></i> </a> </div> </div> <div class="flex flex-col"> <h3 class="text-lg font-bold font-code text-white mb-4"><i class="fas fa-link text-green-400"></i> Quick Links</h3> <ul class="space-y-3"> <li> <a href="/about" class="group relative text-gray-300 hover:text-green-400 transition-colors font-medium  text-gray-400 hover:text-green-400"> <i class="fa fa-user"></i> About </a> </li><li> <a href="/projects" class="group relative text-gray-300 hover:text-green-400 transition-colors font-medium  text-gray-400 hover:text-green-400"> <i class="fa fa-code"></i> Projects </a> </li><li> <a href="/services" class="group relative text-gray-300 hover:text-green-400 transition-colors font-medium  text-gray-400 hover:text-green-400"> <i class="fa fa-cogs"></i> Expertise </a> </li><li> <a href="/blog" class="group relative text-gray-300 hover:text-green-400 transition-colors font-medium  text-gray-400 hover:text-green-400"> <i class="fa fa-blog"></i> Blog </a> </li><li> <a href="/contact" class="group relative text-gray-300 hover:text-green-400 transition-colors font-medium  text-gray-400 hover:text-green-400"> <i class="fa fa-envelope"></i> Contact </a> </li> </ul> </div> <!-- Newsletter --> <div> <h3 class="text-xl font-bold font-code text-white mb-6 flex items-center gap-2"> <i class="fas fa-envelope text-green-400"></i> Newsletter </h3> <p class="text-gray-300 mb-4">Subscribe for the latest tech articles and project updates.</p> <form class="space-y-3"> <input type="email" placeholder="Enter your email" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-gray-300 focus:outline-none focus:border-green-400 transition-colors"> <button type="submit" class="w-full px-4 py-2 bg-green-500 text-gray-900 font-bold rounded-lg hover:bg-green-600 transition-colors flex items-center justify-center gap-2"> <i class="fas fa-paper-plane"></i> Subscribe </button> </form> </div> </div> <!-- Copyright --> <div class="mt-12 pt-8 border-t border-gray-800 flex flex-col md:flex-row justify-between items-center gap-4"> <p class="text-gray-300 text-sm">
© 2026 Weiguang Li. Crafted with  <i class="fas fa-heart text-green-400"></i> and  <i class="fas fa-coffee text-green-400"></i>.
</p> <div class="flex gap-6 text-gray-300 text-sm"> <a href="/privacy" class="hover:text-green-400 transition-colors">Privacy Policy</a><a href="/terms" class="hover:text-green-400 transition-colors">Terms of Service</a> </div> </div> </div> </footer> <button id="back-to-top" class="fixed bottom-6 end-6 bg-gray-800 border border-green-600 font-bold size-10 flex items-center justify-center rounded-full opacity-0 invisible transition-all duration-300 z-50" style="display: none;" title="Back to Top"> <svg class="size-6 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"> <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path> </svg> </button> <script type="module" src="/_astro/Layout.astro_astro_type_script_index_0_lang.B7yG3BKd.js"></script> </body> </html>