<!DOCTYPE html><html lang="en"> <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Zuul Gateway: Principles and Usage</title><meta name="description" content="Java Backend Engineer specializing in Spring Boot, distributed systems, and microservices. Explore my projects, technical blog, and expertise."><meta name="keywords" content="Java, Spring Boot, Backend Developer, Microservices, Distributed Systems, MySQL, Redis, Docker, Kubernetes"><meta name="author" content="Weiguang Li"><meta name="robots" content="index, follow"><link rel="canonical" href="https://oipunk.github.io"><!-- Open Graph --><meta property="og:type" content="website"><meta property="og:url" content="https://oipunk.github.io"><meta property="og:title" content="Zuul Gateway: Principles and Usage"><meta property="og:description" content="Java Backend Engineer specializing in Spring Boot, distributed systems, and microservices. Explore my projects, technical blog, and expertise."><meta property="og:image" content="https://oipunk.github.io/img/og-image.jpg"><!-- Twitter Card --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:title" content="Zuul Gateway: Principles and Usage"><meta name="twitter:description" content="Java Backend Engineer specializing in Spring Boot, distributed systems, and microservices. Explore my projects, technical blog, and expertise."><meta name="twitter:image" content="https://oipunk.github.io/img/og-image.jpg"><link rel="shortcut icon" type="image/x-icon" href="/img/favicon.png"><link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;700&family=Inter:wght@300;400;700;900&display=swap" rel="stylesheet"><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet"><!-- Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=G-DNX03VZHBX"></script><script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-DNX03VZHBX');
    </script><link rel="stylesheet" href="/_astro/about.BWpmdKqS.css"></head> <body class="bg-gray-950 text-gray-100 font-sans"> <header class="sticky top-0 z-50 bg-gray-950/95 backdrop-blur-sm border-b border-gray-800" x-data="{ open: false, scrolled: false }" @scroll.window="scrolled = window.scrollY > 50"> <nav class="max-w-6xl mx-auto px-6 lg:px-12 py-6 flex items-center justify-between"> <a href="/" class="flex items-center gap-2 "> <i class="fas fa-code text-green-400 text-2xl led-glow"></i> <span class="text-xl font-bold font-code text-white">Weiguang Li</span> </a> <div class="hidden md:flex items-center gap-10 main-nav"> <a href="/about" class="group relative text-gray-300 hover:text-green-400 transition-colors font-medium  ">  About </a><a href="/projects" class="group relative text-gray-300 hover:text-green-400 transition-colors font-medium  ">  Projects </a><a href="/services" class="group relative text-gray-300 hover:text-green-400 transition-colors font-medium  ">  Expertise </a><a href="/blog" class="group relative text-gray-300 hover:text-green-400 transition-colors font-medium  ">  Blog </a><a href="/contact" class="group relative text-gray-300 hover:text-green-400 transition-colors font-medium  ">  Contact </a> </div> <div class="md:hidden"> <button @click="open = !open" class="text-gray-300 hover:text-green-400 transition-colors"> <i x-show="!open" style="display: none;" class="fas fa-bars text-2xl"></i> <i x-show="open" class="fas fa-times text-2xl"></i> </button> <div x-show="open" style="display: none;" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 -translate-y-2" x-transition:enter-end="opacity-100 translate-y-0" x-transition:leave="transition ease-in duration-200" x-transition:leave-start="opacity-100 translate-y-0" x-transition:leave-end="opacity-0 -translate-y-2" class="absolute top-full left-0 right-0 bg-gray-950 border-b border-gray-800 p-6 flex flex-col gap-4 shadow-lg"> <a href="/about" class="group relative text-gray-300 hover:text-green-400 transition-colors font-medium  " x-on:click="open = false">  About </a><a href="/projects" class="group relative text-gray-300 hover:text-green-400 transition-colors font-medium  " x-on:click="open = false">  Projects </a><a href="/services" class="group relative text-gray-300 hover:text-green-400 transition-colors font-medium  " x-on:click="open = false">  Expertise </a><a href="/blog" class="group relative text-gray-300 hover:text-green-400 transition-colors font-medium  " x-on:click="open = false">  Blog </a><a href="/contact" class="group relative text-gray-300 hover:text-green-400 transition-colors font-medium  " x-on:click="open = false">  Contact </a> </div> </div> </nav> </header> <main id="main" class="relative bg-gray-900/50 overflow-hidden">  <section class="py-12 max-w-6xl mx-auto px-6 lg:px-12 relative z-10"> <div class="mb-8"> <h1 class="text-3xl lg:text-4xl font-bold font-code text-white mb-2"> <span class="text-white ">Zuul Gateway: </span><span class="text-green-500 ">Principles and </span><span class="text-white ">Usage</span> </h1> <div class="flex items-center gap-4 text-gray-400"> <i class="fas fa-calendar-alt"></i> <span>July 28, 2020</span> <span>|</span> <span>67 min read</span> </div> </div> <div class="py-8 px-6 bg-gray-950 rounded-lg border border-gray-800 mb-8"> <div class="relative mb-8"> <img src="/img/blog4.jpg" alt="Zuul Gateway: Principles and Usage" class="w-full object-cover rounded-lg border border-gray-800"> </div> <div class="post-content text-gray-300 space-y-8"><p><h1>网关</h1></p><p>Starter阿里云镜像</p><p><a href="https://start.aliyun.com/">https://start.aliyun.com/</a></p><p><h2>概念</h2></p><p>微服务基本模块已经有了-也可以做微服务了。但完成一个复杂的业务-可能需要多个微服务合作来完成-比如下单-需要用户服务-支付服务-地图服务-订单服务。一般是我们对外服务的窗口-进行服务内外隔离。一般微服务都在内网-不做安全验证-</p><p>就好像：很多明星-可以独立开演唱会（独立提供服务）。也可以去春晚（微服务群提供服务）。但一台春晚就不能让 观众一个一个调用了。观众要调用-需要检票啥的-检票就类似于网关-进来之后-界面随便看-不会说你 看个小品-还需要再检票。</p><p>微服务没有网关-会有下面的问题：</p><p><li> 客户端请求多个微服务-增加了客户端复杂性-每个微服务都要做用户认证-限流等-避免和多个微服务打交道的复杂性。</li>
<li> 有跨域问题-不在同一个域。</li>
<li> 认证复杂-每个服务都要独立认证-服务要求的权限不一致。</li>
<li> 难以重构。因为微服务被客户端调用着-重构难以实施。</li></p><p>网关是介于客户端（外部调用方比如app-h5）和微服务的中间层。</p><p>Zuul是Netflix开源的微服务网关-核心是一系列过滤器。这些过滤器可以完成以下功能。</p><p><li> 是所有微服务入口-进行分发。</li>
<li> 身份认证与安全。识别合法的请求-拦截不合法的请求。</li>
<li> 监控。在入口处监控-更全面。</li>
<li> 动态路由。动态将请求分发到不同的后端集群。</li>
<li> 压力测试。可以逐渐增加对后端服务的流量-进行测试。</li>
<li> 负载均衡。也是用ribbon。</li>
<li> 限流（望京超市）。比如我每秒只要1000次-10001次就不让访问了。</li>
<li> 服务熔断</li></p><p>网关和服务的关系：演员和剧场检票人员的关系。</p><p>zuul默认集成了：ribbon和hystrix。</p><p><h2>启用网关</h2></p><p>新建项目引入依赖</p><p>``<code>plain
	org.springframework.cloud	spring-cloud-starter-netflix-eureka-client	org.springframework.cloud	spring-cloud-starter-netflix-zuul
</code>`<code></p><p>配置文件</p><p></code>`<code>plain
eureka.client.service-url.defaultZone=http://euk1.com:7001/eureka/spring.application.name=zuulserverserver.port=80
</code>`<code></p><p>启动类</p><p></code>`<code>plain
@EnableZuulProxy
</code>`<code></p><p>测试访问</p><p>网关会将服务名转换成具体服务的ip和端口-实际进行访问</p><p></code>`<code>plain
http://localhost/consumer/alive
</code>`<code></p><p><h3>负载均衡</h3></p><p>启动两个Consumer</p><p>轮询访问上面地址-会看到返回结果中-端口一直轮询在变。说明负载均衡生效了-默认是轮询</p><p></code>`<code>plain
consumer.ribbon.NFLoadBalancerRuleClassName=com.netflix.loadbalancer.RandomRule
</code>`<code></p><p><h3>路由端点</h3></p><p>调试的时候-看网关请求的地址-以及 映射是否正确。网关请求有误时-可以通过此处排查错误。</p><p>配置</p><p></code>`<code>plain
management.endpoints.web.exposure.include=*management.endpoint.health.show-details=alwaysmanagement.endpoint.health.enabled=truemanagement.endpoint.routes.enabled=true
</code>`<code></p><p><h3>配置指定微服务的访问路径</h3></p><p><li> 通过服务名配置（虚拟主机名）</li></p><p></code>`<code>sh
zuul.routes.consumer=/xxoo/**
</code>`<code></p><p>配置前先访问-然后做对比。</p><p>2.自定义映射</p><p></code>`<code>plain
zuul.routes.xx.path=/xx/**zuul.routes.xx.url=http://mashibing.com
</code>`<code></p><p><li> .自定义下的负载均衡</li></p><p></code>`<code>plain
zuul.routes.xx.path=/xx/**zuul.routes.xx.service-id=cuidcuid.ribbon.listOfServers=localhost:82,localhost:83ribbon.eureka.enabled=false
</code>`<code></p><p><h3>忽略微服务</h3></p><p>配置</p><p></code>`<code>plain
zuul.ignored-services=user-provider
</code>`<code></p><p><h3>前缀</h3></p><p></code>`<code>plain
zuul.prefix=/api/v1
</code>`<code></p><p>带上前缀请求</p><p></code>`<code>plain
zuul.strip-prefix=false
</code>`<code></p><p><h3>高可用</h3></p><p>Nginx + Keepalive</p><p><h3>敏感Header</h3></p><p>测试点：</p><p>停止一个api-driver。访问：yapi：网关token-看返回。</p><p>初始请求。返回值中token为msb cookie</p><p>加上下面配置</p><p>敏感的header不会传播到下游去-也就是说此处的token不会传播的其它的微服务中去。</p><p></code>`<code>sh
zuul:  #一下配置-表示忽略下面的值向微服务传播-以下配置为空表示：所有请求头都透传到后面微服务。  sensitive-headers: token
</code>`<code></p><p>访问。网关token为null。</p><p>---</p><p>上面是网关的路由。</p><p><h3>过滤器</h3></p><p>Zuul的大部分功能都是有过滤器实现的。</p><p>4种过滤器</p><p></code>`<code>sh
PRE: 在请求被路由之前调用-可利用这种过滤器实现身份验证。选择微服务-记录日志。ROUTING:在将请求路由到微服务调用-用于构建发送给微服务的请求-并用http clinet（或者ribbon）请求微服务。POST:在调用微服务执行后。可用于添加header-记录日志-将响应发给客户端。ERROR:在其他阶段发生错误是-走此过滤器。
</code>`<code></p><p>自定义过滤器</p><p></code>`<code>sh
PreFilter看代码-注意下面4点。filterType：pre-routing,post,errorfilterOrder:执行顺序-在谁前-在谁后-可以+1--1shouldFilter：此过滤器是否执行-true  false-可以写过滤器是否执行的判断条件。run：具体执行逻辑。
</code>`<code></p><p>访问：yapi中 网关token</p><p></code>`<code>sh
pre来源uri：/api-driver/test/tokenpre拦截pre 业务逻辑 token:msb coolie
</code>`<code></p><p>说一下AuthFilter。利用filter实现了 鉴权。看代码。（实际用jwt）</p><p>测试一下-</p><p></code>`<code>sh
// 测试路径//		if(uri.contains("api-driver")) {//			return true;//		}
</code>`<code></p><p><h3>接口容错</h3></p><p></code>`<code>sh
@Componentpublic class MsbFallback implements FallbackProvider{	/**	 * 表明为哪个微服务提供回退	 * 服务Id -若需要所有服务调用都支持回退-返回null 或者 * 即可	 */	@Override	public String getRoute() {		// TODO Auto-generated method stub		return "*";	}	@Override	public ClientHttpResponse fallbackResponse(String route, Throwable cause) {				if (cause instanceof HystrixTimeoutException) {            return response(HttpStatus.GATEWAY_TIMEOUT);        } else {            return response(HttpStatus.INTERNAL_SERVER_ERROR);        }					}		private ClientHttpResponse response(final HttpStatus status) {        return new ClientHttpResponse() {            @Override            public HttpStatus getStatusCode() throws IOException {                //return status;                return HttpStatus.BAD_REQUEST;            }            @Override            public int getRawStatusCode() throws IOException {                //return status.value();                return HttpStatus.BAD_REQUEST.value();            }            @Override            public String getStatusText() throws IOException {                //return s</div> </div> <div class="p-6 bg-gray-950 rounded-lg border border-gray-800 mb-8"> <div class="flex flex-col sm:flex-row items-center gap-6"> <img src="/img/male2.jpg" alt="Weiguang Li" class="w-16 h-16 rounded-full object-cover"> <div> <h4 class="max-sm:text-center text-lg font-bold text-white mb-1">Weiguang Li</h4> <p class="text-gray-300 mb-3">Java Backend Engineer specializing in Spring Boot, distributed systems, and microservices. Passionate about clean code and continuous learning.</p> <div class="flex gap-4"> <a href="https://github.com/OiPunk" target="_blank" class="text-gray-300 hover:text-green-400 text-xl"> <i class="fab fa-github"></i> </a> <a href="https://linkedin.com/in/" target="_blank" class="text-gray-300 hover:text-green-400 text-xl"> <i class="fab fa-linkedin"></i> </a> <a href="https://twitter.com/" target="_blank" class="text-gray-300 hover:text-green-400 text-xl"> <i class="fab fa-twitter"></i> </a> </div> </div> </div> </div> <div class="relative"> <h3 class="text-xl font-bold font-code text-white mb-6 flex items-center gap-2"> <i class="fas fa-book text-green-400 led-glow"></i> Related Articles
</h3> <div class="grid grid-cols-1 gap-6"> <a href="/blog/2020-07-02" class="bg-gray-950 rounded-lg border border-gray-800 flex flex-col md:flex-row gap-4 related-card overflow-hidden transition-transform"> <img src="/img/blog5.jpg" alt="Distributed Transaction Solutions" class="w-full md:w-1/4 object-cover"> <div class="p-6 flex-1"> <h4 class="text-lg font-bold font-code text-white mb-1">Distributed Transaction Solutions</h4> <p class="text-gray-300 text-sm">Comprehensive overview of distributed transaction patterns including 2PC, TCC, Saga, and eventual consistency implementations.</p> <div class="flex items-center gap-2 text-gray-400 text-sm mt-2"> <i class="fas fa-calendar-alt"></i> <span>July 2, 2020</span> </div> </div> </a><a href="/blog/2020-06-23-spring-cloud-eurekaactuator" class="bg-gray-950 rounded-lg border border-gray-800 flex flex-col md:flex-row gap-4 related-card overflow-hidden transition-transform"> <img src="/img/blog4.jpg" alt="Spring Cloud: Eureka &#38; Actuator Basics" class="w-full md:w-1/4 object-cover"> <div class="p-6 flex-1"> <h4 class="text-lg font-bold font-code text-white mb-1">Spring Cloud: Eureka &amp; Actuator Basics</h4> <p class="text-gray-300 text-sm">In-depth technical analysis with code examples and enterprise best practices.</p> <div class="flex items-center gap-2 text-gray-400 text-sm mt-2"> <i class="fas fa-calendar-alt"></i> <span>June 23, 2020</span> </div> </div> </a> </div> </div> </section>  </main> <footer class="bg-dark py-16 relative overflow-hidden"> <div class="absolute inset-0 bg-hero opacity-[.03]"></div> <div class="max-w-6xl mx-auto px-6 lg:px-12 relative"> <div class="grid grid-cols-1 md:grid-cols-4 gap-12"> <div class="md:col-span-2 flex flex-col items-center md:items-start"> <a href="/" class="flex items-center gap-2 mb-4"> <i class="fas fa-code text-green-400 text-2xl led-glow"></i> <span class="text-xl font-bold font-code text-white">Weiguang Li</span> </a> <p class="text-gray-400 text-left lg:pe-16"> Java Backend Engineer specializing in Spring Boot, distributed systems, and microservices. Passionate about open source and continuous learning. </p> <div class="flex gap-4 mt-4"> <a href="https://github.com/OiPunk" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-green-400 transition-colors"> <i class="fab fa-github text-2xl"></i> </a> </div> </div> <div class="flex flex-col"> <h3 class="text-lg font-bold font-code text-white mb-4"><i class="fas fa-link text-green-400"></i> Quick Links</h3> <ul class="space-y-3"> <li> <a href="/about" class="group relative text-gray-300 hover:text-green-400 transition-colors font-medium  text-gray-400 hover:text-green-400"> <i class="fa fa-user"></i> About </a> </li><li> <a href="/projects" class="group relative text-gray-300 hover:text-green-400 transition-colors font-medium  text-gray-400 hover:text-green-400"> <i class="fa fa-code"></i> Projects </a> </li><li> <a href="/services" class="group relative text-gray-300 hover:text-green-400 transition-colors font-medium  text-gray-400 hover:text-green-400"> <i class="fa fa-cogs"></i> Expertise </a> </li><li> <a href="/blog" class="group relative text-gray-300 hover:text-green-400 transition-colors font-medium  text-gray-400 hover:text-green-400"> <i class="fa fa-blog"></i> Blog </a> </li><li> <a href="/contact" class="group relative text-gray-300 hover:text-green-400 transition-colors font-medium  text-gray-400 hover:text-green-400"> <i class="fa fa-envelope"></i> Contact </a> </li> </ul> </div> <!-- Newsletter --> <div> <h3 class="text-xl font-bold font-code text-white mb-6 flex items-center gap-2"> <i class="fas fa-envelope text-green-400"></i> Newsletter </h3> <p class="text-gray-300 mb-4">Subscribe for the latest tech articles and project updates.</p> <form class="space-y-3"> <input type="email" placeholder="Enter your email" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-gray-300 focus:outline-none focus:border-green-400 transition-colors"> <button type="submit" class="w-full px-4 py-2 bg-green-500 text-gray-900 font-bold rounded-lg hover:bg-green-600 transition-colors flex items-center justify-center gap-2"> <i class="fas fa-paper-plane"></i> Subscribe </button> </form> </div> </div> <!-- Copyright --> <div class="mt-12 pt-8 border-t border-gray-800 flex flex-col md:flex-row justify-between items-center gap-4"> <p class="text-gray-300 text-sm">
© 2026 Weiguang Li. Crafted with  <i class="fas fa-heart text-green-400"></i> and  <i class="fas fa-coffee text-green-400"></i>.
</p> <div class="flex gap-6 text-gray-300 text-sm"> <a href="/privacy" class="hover:text-green-400 transition-colors">Privacy Policy</a><a href="/terms" class="hover:text-green-400 transition-colors">Terms of Service</a> </div> </div> </div> </footer> <button id="back-to-top" class="fixed bottom-6 end-6 bg-gray-800 border border-green-600 font-bold size-10 flex items-center justify-center rounded-full opacity-0 invisible transition-all duration-300 z-50" style="display: none;" title="Back to Top"> <svg class="size-6 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"> <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path> </svg> </button> <script type="module" src="/_astro/Layout.astro_astro_type_script_index_0_lang.B7yG3BKd.js"></script> </body> </html>