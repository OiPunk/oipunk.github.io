<!DOCTYPE html><html lang="en"> <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Hystrix: Circuit Breaker Patterns</title><meta name="description" content="Java Backend Engineer specializing in Spring Boot, distributed systems, and microservices. Explore my projects, technical blog, and expertise."><meta name="keywords" content="Java, Spring Boot, Backend Developer, Microservices, Distributed Systems, MySQL, Redis, Docker, Kubernetes"><meta name="author" content="Weiguang Li"><meta name="robots" content="index, follow"><link rel="canonical" href="https://oipunk.github.io"><!-- Open Graph --><meta property="og:type" content="website"><meta property="og:url" content="https://oipunk.github.io"><meta property="og:title" content="Hystrix: Circuit Breaker Patterns"><meta property="og:description" content="Java Backend Engineer specializing in Spring Boot, distributed systems, and microservices. Explore my projects, technical blog, and expertise."><meta property="og:image" content="https://oipunk.github.io/img/og-image.jpg"><!-- Twitter Card --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:title" content="Hystrix: Circuit Breaker Patterns"><meta name="twitter:description" content="Java Backend Engineer specializing in Spring Boot, distributed systems, and microservices. Explore my projects, technical blog, and expertise."><meta name="twitter:image" content="https://oipunk.github.io/img/og-image.jpg"><link rel="shortcut icon" type="image/x-icon" href="/img/favicon.png"><link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;700&family=Inter:wght@300;400;700;900&display=swap" rel="stylesheet"><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet"><!-- Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=G-DNX03VZHBX"></script><script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-DNX03VZHBX');
    </script><link rel="stylesheet" href="/_astro/about.BWpmdKqS.css"></head> <body class="bg-gray-950 text-gray-100 font-sans"> <header class="sticky top-0 z-50 bg-gray-950/95 backdrop-blur-sm border-b border-gray-800" x-data="{ open: false, scrolled: false }" @scroll.window="scrolled = window.scrollY > 50"> <nav class="max-w-6xl mx-auto px-6 lg:px-12 py-6 flex items-center justify-between"> <a href="/" class="flex items-center gap-2 "> <i class="fas fa-code text-green-400 text-2xl led-glow"></i> <span class="text-xl font-bold font-code text-white">Weiguang Li</span> </a> <div class="hidden md:flex items-center gap-10 main-nav"> <a href="/about" class="group relative text-gray-300 hover:text-green-400 transition-colors font-medium  ">  About </a><a href="/projects" class="group relative text-gray-300 hover:text-green-400 transition-colors font-medium  ">  Projects </a><a href="/services" class="group relative text-gray-300 hover:text-green-400 transition-colors font-medium  ">  Expertise </a><a href="/blog" class="group relative text-gray-300 hover:text-green-400 transition-colors font-medium  ">  Blog </a><a href="/contact" class="group relative text-gray-300 hover:text-green-400 transition-colors font-medium  ">  Contact </a> </div> <div class="md:hidden"> <button @click="open = !open" class="text-gray-300 hover:text-green-400 transition-colors"> <i x-show="!open" style="display: none;" class="fas fa-bars text-2xl"></i> <i x-show="open" class="fas fa-times text-2xl"></i> </button> <div x-show="open" style="display: none;" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 -translate-y-2" x-transition:enter-end="opacity-100 translate-y-0" x-transition:leave="transition ease-in duration-200" x-transition:leave-start="opacity-100 translate-y-0" x-transition:leave-end="opacity-0 -translate-y-2" class="absolute top-full left-0 right-0 bg-gray-950 border-b border-gray-800 p-6 flex flex-col gap-4 shadow-lg"> <a href="/about" class="group relative text-gray-300 hover:text-green-400 transition-colors font-medium  " x-on:click="open = false">  About </a><a href="/projects" class="group relative text-gray-300 hover:text-green-400 transition-colors font-medium  " x-on:click="open = false">  Projects </a><a href="/services" class="group relative text-gray-300 hover:text-green-400 transition-colors font-medium  " x-on:click="open = false">  Expertise </a><a href="/blog" class="group relative text-gray-300 hover:text-green-400 transition-colors font-medium  " x-on:click="open = false">  Blog </a><a href="/contact" class="group relative text-gray-300 hover:text-green-400 transition-colors font-medium  " x-on:click="open = false">  Contact </a> </div> </div> </nav> </header> <main id="main" class="relative bg-gray-900/50 overflow-hidden">  <section class="py-12 max-w-6xl mx-auto px-6 lg:px-12 relative z-10"> <div class="mb-8"> <h1 class="text-3xl lg:text-4xl font-bold font-code text-white mb-2"> <span class="text-white ">Hystrix: Circuit </span><span class="text-green-500 ">Breaker Patterns</span> </h1> <div class="flex items-center gap-4 text-gray-400"> <i class="fas fa-calendar-alt"></i> <span>August 3, 2020</span> <span>|</span> <span>100 min read</span> </div> </div> <div class="py-8 px-6 bg-gray-950 rounded-lg border border-gray-800 mb-8"> <div class="relative mb-8"> <img src="/img/blog6.jpg" alt="Hystrix: Circuit Breaker Patterns" class="w-full object-cover rounded-lg border border-gray-800"> </div> <div class="post-content text-gray-300 space-y-8"><p><h1>Hystrix</h1></p><p><h2>1 概念：</h2></p><p><h3>概述</h3></p><p>​ 在分布式系统下-微服务之间不可避免地会发生相互调用-但每个系统都无法百分之百保证自身运行不出问题。在服务调用中-很可能面临依赖服务失效的问题（网络延时-服务异常-负载过大无法及时响应）。因此需要一个组件-能提供强大的容错能力-为服务间调用提供保护和控制。</p><p>我们的目的：<strong>_当我自身 依赖的服务不可用时-服务自身不会被拖垮。防止微服务级联异常_</strong>。</p><p>图。</p><p>本质：就是隔离坏的服务-不让坏服务拖垮其他服务（调用坏服务的服务）。</p><p>比如：武汉发生疫情-隔离它-不让依赖于武汉的地方感染。</p><p>和我们课程中熔断降级更贴切一点：北京从武汉招聘大学生-武汉有疫情了-当北京去武汉请求大学生来的时候-武汉熔断-然后北京启动自身的备用逻辑：去上海找大学生（降级）。</p><p><h3>舱壁模式</h3></p><p>舱壁模式（Bulkhead）隔离了每个工作负载或服务的关键资源-如连接池、内存和CPU-硬盘。每个工作单元都有独立的 连接池-内存-CPU。</p><p>使用舱壁避免了单个服务消耗掉所有资源-从而导致其他服务出现故障的场景。  
这种模式主要是通过防止由一个服务引起的级联故障来增加系统的弹性。</p><p>据说泰坦尼克原因：泰坦尼克号上有16个防水舱-设计可以保障如果只有4个舱进水-密闭和隔离可以阻止水继续进入下一个防水舱-从而保证船的基本浮力。</p><p>但是当时冰山从侧面划破了船体-从而导致有5个防水舱同时进水-而为了建造豪华的头等舱大厅-也就是电影里杰克和罗斯约会的地方-5号舱的顶部并未达到密闭所需要的高度-水就一层层进入了船体-隔离的失败导致了泰坦尼克的沉没。</p><p>> 舱壁模式<img src="/images/blog/%E8%88%B1%E5%A3%81%E6%A8%A1%E5%BC%8F.png" alt="illustration" class="my-4" /></p><p>给我们的思路：可以对每个请求设置-单独的连接池-配置连接数-不要影响 别的请求。就像一个一个的防水舱。</p><p>对在公司中的管理也一样：给每个独立的 小组-分配独立的资源-比如产品-开发-测试。在小公司-大多数情况 这些资源都是共享的-有一个好处是充分利用资源-坏处是-如果一个项目延期-会影响别的项目推进。自己权衡利弊。</p><p>最近比较火的一句话： 真正的知识-是 产品提高一个等级和成本提高0.2元的 痛苦抉择。</p><p><h3>雪崩效应</h3></p><p>​ 每个服务 发出一个HTTP请求都会 在 服务中 开启一个新线程。而下游服务挂了或者网络不可达-通常线程会阻塞住-直到Timeout。如果并发量多一点-这些阻塞的线程就会占用大量的资源-很有可能把自己本身这个微服务所在的机器资源耗尽-导致自己也挂掉。</p><p>​ 如果服务提供者响应非常缓慢-那么服务消费者调用此提供者就会一直等待-直到提供者响应或超时。在高并发场景下-此种情况-如果不做任何处理-就会导致服务消费者的资源耗竭甚至整个系统的崩溃。一层一层的崩溃-导致所有的系统崩溃。</p><p>> 《雪崩示意图》<img src="/images/blog/%E9%9B%AA%E5%B4%A9%E7%A4%BA%E6%84%8F%E5%9B%BE.png" alt="illustration" class="my-4" /></p><p>​ 雪崩：由基础服务故障导致级联故障的现象。描述的是：提供者不可用 导致消费者不可用-并将不可用逐渐放大的过程。像滚雪球一样-不可用的服务越来越多。影响越来越恶劣。</p><p>雪崩三个流程：</p><p>服务提供者不可用</p><p>重试会导致网络流量加大-更影响服务提供者。</p><p>导致服务调用者不可用-由于服务调用者 一直等待返回-一直占用系统资源。</p><p>（不可用的范围 被逐步放大）</p><p>服务不可用原因：</p><p>服务器宕机</p><p>网络故障</p><p>宕机</p><p>程序异常</p><p>负载过大-导致服务提供者响应慢</p><p>缓存击穿导致服务超负荷运行</p><p>总之 ： 基础服务故障 导致 级联故障 就是 雪崩。</p><p><h3>容错机制</h3></p><p><li> 为网络请求设置超时。</li></p><p>    必须为网络请求设置超时。一般的调用一般在几十毫秒内响应。如果服务不可用-或者网络有问题-那么响应时间会变很长。长到几十秒。</p><p>    每一次调用-对应一个线程或进程-如果响应时间长-那么线程就长时间得不到释放-而线程对应着系统资源-包括CPU,内存-得不到释放的线程越多-资源被消耗的越多-最终导致系统崩溃。</p><p>    因此必须设置超时时间-让资源尽快释放。</p><p><li> 使用断路器模式。</li></p><p>    想一下家里的保险丝-跳闸。如果家里有短路或者大功率电器使用-超过电路负载时-就会跳闸-如果不跳闸-电路烧毁-波及到其他家庭-导致其他家庭也不可用。通过跳闸保护电路安全-当短路问题-或者大功率问题被解决-在合闸。</p><p>    自己家里电路-不影响整个小区每家每户的电路。</p><p><h3>断路器</h3></p><p>``<code>
如果对某个微服务请求有大量超时（说明该服务不可用）-再让新的请求访问该服务就没有意义-只会无谓的消耗资源。例如设置了超时时间1s-如果短时间内有大量的请求无法在1s内响应-就没有必要去请求依赖的服务了。
</code>`<code></p><p><li> 断路器是对容易导致错误的操作的代理。这种代理能统计一段时间内的失败次数-并依据次数决定是正常请求依赖的服务还是直接返回。</li>
<li> 断路器可以实现快速失败-如果它在一段时间内检测到许多类似的错误（超时）-就会在之后的一段时间-强迫对该服务的调用快速失败-即不再请求所调用的服务。这样对于消费者就无须再浪费CPU去等待长时间的超时。</li>
<li> 断路器也可自动诊断依赖的服务是否恢复正常。如果发现依赖的服务已经恢复正常-那么就会恢复请求该服务。通过重置时间来决定断路器的重新闭合。</li></p><p>    这样就实现了微服务的“自我修复”：当依赖的服务不可用时-打开断路器-让服务快速失败-从而防止雪崩。当依赖的服务恢复正常时-又恢复请求。</p><p>> 断路器开关时序图<img src="/images/blog/%E6%96%AD%E8%B7%AF%E5%99%A8%E5%BC%80%E5%85%B3%E6%97%B6%E5%BA%8F%E5%9B%BE.png" alt="illustration" class="my-4" /></p><p></code>`<code>sh
第一次正常第二次提供者异常提供者多次异常后-断路器打开后续请求-则直接降级-走备用逻辑。
</code>`<code></p><p>​ 断路器状态转换的逻辑：</p><p></code>`<code>plain
关闭状态：正常情况下-断路器关闭-可以正常请求依赖的服务。打开状态：当一段时间内-请求失败率达到一定阈值-断路器就会打开。服务请求不会去请求依赖的服务。调用方直接返回。不发生真正的调用。重置时间过后-进入半开模式。半开状态：断路器打开一段时间后-会自动进入“半开模式”-此时-断路器允许一个服务请求访问依赖的服务。如果此请求成功(或者成功达到一定比例)-则关闭断路器-恢复正常访问。否则-则继续保持打开状态。断路器的打开-能保证服务调用者在调用异常服务时-快速返回结果-避免大量的同步等待-减少服务调用者的资源消耗。并且断路器能在打开一段时间后继续侦测请求执行结果-判断断路器是否能关闭-恢复服务的正常调用。
</code>`<code></p><p>> 《熔断.doc》《断路器开关时序图》《状态转换》</p><p><h3>降级</h3></p><p>为了在整体资源不够的时候-适当放弃部分服务-将主要的资源投放到核心服务中-待渡过难关之后-再重启已关闭的服务-保证了系统核心服务的稳定。当服务停掉后-自动进入fallback替换主方法。</p><p>用fallback方法代替主方法执行并返回结果-对失败的服务进行降级。当调用服务失败次数在一段时间内超过了断路器的阈值时-断路器将打开-不再进行真正的调用-而是快速失败-直接执行fallback逻辑。服务降级保护了服务调用者的逻辑。</p><p></code>`<code>sh
熔断和降级：共同点：	1、为了防止系统崩溃-保证主要功能的可用性和可靠性。	2、用户体验到某些功能不能用。不同点：	1、熔断由下级故障触发-主动惹祸。	2、降级由调用方从负荷角度触发-无辜被抛弃。
</code>`<code></p><p>19年春晚 百度 红包-凤巢的5万台机器熄火4小时-让给了红包。</p><p><h3>Hystrix</h3></p><p>spring cloud 用的是 hystrix-是一个容错组件。</p><p>Hystrix实现了 超时机制和断路器模式。</p><p>Hystrix是Netflix开源的一个类库-用于隔离远程系统、服务或者第三方库-防止级联失败-从而提升系统的可用性与容错性。主要有以下几点功能：</p><p><li> 为系统提供保护机制。在依赖的服务出现高延迟或失败时-为系统提供保护和控制。</li>
<li> 防止雪崩。</li>
<li> 包裹请求：使用HystrixCommand（或HystrixObservableCommand）包裹对依赖的调用逻辑-每个命令在独立线程中运行。</li>
<li> 跳闸机制：当某服务失败率达到一定的阈值时-Hystrix可以自动跳闸-停止请求该服务一段时间。</li>
<li> 资源隔离：Hystrix为每个请求都的依赖都维护了一个小型线程池-如果该线程池已满-发往该依赖的请求就被立即拒绝-而不是排队等候-从而加速失败判定。防止级联失败。</li>
<li> 快速失败：Fail Fast。同时能快速恢复。侧重点是：（不去真正的请求服务-发生异常再返回）-而是直接失败。</li>
<li> 监控：Hystrix可以实时监控运行指标和配置的变化-提供近实时的监控、报警、运维控制。</li>
<li> 回退机制：fallback-当请求失败、超时、被拒绝-或当断路器被打开时-执行回退逻辑。回退逻辑我们自定义-提供优雅的服务降级。</li>
<li> 自我修复：断路器打开一段时间后-会自动进入“半开”状态-可以进行打开-关闭-半开状态的转换。前面有介绍。</li></p><p><h2>2 Hystrix 使用</h2></p><p><h3>hystrix独立使用脱离spring cloud</h3></p><p>代码：study-hystrix项目-HelloWorldHystrixCommand类。看着类讲解。</p><p>关注点：</p><p>继承hystrixCommand</p><p>重写run</p><p>fallback（程序发生非HystrixBadRequestException异常-运行超时-熔断开关打开-线程池/信号量满了）</p><p>熔断（熔断机制相当于电路的跳闸功能-我们可以配置熔断策略为当请求错误比例在10s内>50%时-该服务将进入熔断状态-后续请求都会进入fallback。）</p><p>结果缓存（支持将一个请求结果缓存起来-下一个具有相同key的请求将直接从缓存中取出结果-减少请求开销。）</p><p>这个例子-只是独立使用hystrix- 通过这个例子-了解 hystrix </div> </div> <div class="p-6 bg-gray-950 rounded-lg border border-gray-800 mb-8"> <div class="flex flex-col sm:flex-row items-center gap-6"> <img src="/img/male2.jpg" alt="Weiguang Li" class="w-16 h-16 rounded-full object-cover"> <div> <h4 class="max-sm:text-center text-lg font-bold text-white mb-1">Weiguang Li</h4> <p class="text-gray-300 mb-3">Java Backend Engineer specializing in Spring Boot, distributed systems, and microservices. Passionate about clean code and continuous learning.</p> <div class="flex gap-4"> <a href="https://github.com/OiPunk" target="_blank" class="text-gray-300 hover:text-green-400 text-xl"> <i class="fab fa-github"></i> </a> <a href="https://linkedin.com/in/" target="_blank" class="text-gray-300 hover:text-green-400 text-xl"> <i class="fab fa-linkedin"></i> </a> <a href="https://twitter.com/" target="_blank" class="text-gray-300 hover:text-green-400 text-xl"> <i class="fab fa-twitter"></i> </a> </div> </div> </div> </div> <div class="relative"> <h3 class="text-xl font-bold font-code text-white mb-6 flex items-center gap-2"> <i class="fas fa-book text-green-400 led-glow"></i> Related Articles
</h3> <div class="grid grid-cols-1 gap-6"> <a href="/blog/2020-07-02" class="bg-gray-950 rounded-lg border border-gray-800 flex flex-col md:flex-row gap-4 related-card overflow-hidden transition-transform"> <img src="/img/blog5.jpg" alt="Distributed Transaction Solutions" class="w-full md:w-1/4 object-cover"> <div class="p-6 flex-1"> <h4 class="text-lg font-bold font-code text-white mb-1">Distributed Transaction Solutions</h4> <p class="text-gray-300 text-sm">Comprehensive overview of distributed transaction patterns including 2PC, TCC, Saga, and eventual consistency implementations.</p> <div class="flex items-center gap-2 text-gray-400 text-sm mt-2"> <i class="fas fa-calendar-alt"></i> <span>July 2, 2020</span> </div> </div> </a><a href="/blog/2020-06-23-spring-cloud-eurekaactuator" class="bg-gray-950 rounded-lg border border-gray-800 flex flex-col md:flex-row gap-4 related-card overflow-hidden transition-transform"> <img src="/img/blog4.jpg" alt="Spring Cloud: Eureka &#38; Actuator Basics" class="w-full md:w-1/4 object-cover"> <div class="p-6 flex-1"> <h4 class="text-lg font-bold font-code text-white mb-1">Spring Cloud: Eureka &amp; Actuator Basics</h4> <p class="text-gray-300 text-sm">In-depth technical analysis with code examples and enterprise best practices.</p> <div class="flex items-center gap-2 text-gray-400 text-sm mt-2"> <i class="fas fa-calendar-alt"></i> <span>June 23, 2020</span> </div> </div> </a> </div> </div> </section>  </main> <footer class="bg-dark py-16 relative overflow-hidden"> <div class="absolute inset-0 bg-hero opacity-[.03]"></div> <div class="max-w-6xl mx-auto px-6 lg:px-12 relative"> <div class="grid grid-cols-1 md:grid-cols-4 gap-12"> <div class="md:col-span-2 flex flex-col items-center md:items-start"> <a href="/" class="flex items-center gap-2 mb-4"> <i class="fas fa-code text-green-400 text-2xl led-glow"></i> <span class="text-xl font-bold font-code text-white">Weiguang Li</span> </a> <p class="text-gray-400 text-left lg:pe-16"> Java Backend Engineer specializing in Spring Boot, distributed systems, and microservices. Passionate about open source and continuous learning. </p> <div class="flex gap-4 mt-4"> <a href="https://github.com/OiPunk" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-green-400 transition-colors"> <i class="fab fa-github text-2xl"></i> </a> </div> </div> <div class="flex flex-col"> <h3 class="text-lg font-bold font-code text-white mb-4"><i class="fas fa-link text-green-400"></i> Quick Links</h3> <ul class="space-y-3"> <li> <a href="/about" class="group relative text-gray-300 hover:text-green-400 transition-colors font-medium  text-gray-400 hover:text-green-400"> <i class="fa fa-user"></i> About </a> </li><li> <a href="/projects" class="group relative text-gray-300 hover:text-green-400 transition-colors font-medium  text-gray-400 hover:text-green-400"> <i class="fa fa-code"></i> Projects </a> </li><li> <a href="/services" class="group relative text-gray-300 hover:text-green-400 transition-colors font-medium  text-gray-400 hover:text-green-400"> <i class="fa fa-cogs"></i> Expertise </a> </li><li> <a href="/blog" class="group relative text-gray-300 hover:text-green-400 transition-colors font-medium  text-gray-400 hover:text-green-400"> <i class="fa fa-blog"></i> Blog </a> </li><li> <a href="/contact" class="group relative text-gray-300 hover:text-green-400 transition-colors font-medium  text-gray-400 hover:text-green-400"> <i class="fa fa-envelope"></i> Contact </a> </li> </ul> </div> <!-- Newsletter --> <div> <h3 class="text-xl font-bold font-code text-white mb-6 flex items-center gap-2"> <i class="fas fa-envelope text-green-400"></i> Newsletter </h3> <p class="text-gray-300 mb-4">Subscribe for the latest tech articles and project updates.</p> <form class="space-y-3"> <input type="email" placeholder="Enter your email" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-gray-300 focus:outline-none focus:border-green-400 transition-colors"> <button type="submit" class="w-full px-4 py-2 bg-green-500 text-gray-900 font-bold rounded-lg hover:bg-green-600 transition-colors flex items-center justify-center gap-2"> <i class="fas fa-paper-plane"></i> Subscribe </button> </form> </div> </div> <!-- Copyright --> <div class="mt-12 pt-8 border-t border-gray-800 flex flex-col md:flex-row justify-between items-center gap-4"> <p class="text-gray-300 text-sm">
© 2026 Weiguang Li. Crafted with  <i class="fas fa-heart text-green-400"></i> and  <i class="fas fa-coffee text-green-400"></i>.
</p> <div class="flex gap-6 text-gray-300 text-sm"> <a href="/privacy" class="hover:text-green-400 transition-colors">Privacy Policy</a><a href="/terms" class="hover:text-green-400 transition-colors">Terms of Service</a> </div> </div> </div> </footer> <button id="back-to-top" class="fixed bottom-6 end-6 bg-gray-800 border border-green-600 font-bold size-10 flex items-center justify-center rounded-full opacity-0 invisible transition-all duration-300 z-50" style="display: none;" title="Back to Top"> <svg class="size-6 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"> <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path> </svg> </button> <script type="module" src="/_astro/Layout.astro_astro_type_script_index_0_lang.B7yG3BKd.js"></script> </body> </html>