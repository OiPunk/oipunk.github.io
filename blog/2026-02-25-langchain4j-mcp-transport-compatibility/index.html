<!DOCTYPE html><html lang="en"> <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>How I Fixed a Core MCP Transport Compatibility Bug in LangChain4j</title><meta name="description" content="Java Backend Engineer specializing in Spring Boot, distributed systems, and microservices. Explore my projects, technical blog, and expertise."><meta name="keywords" content="Java, Spring Boot, Backend Developer, Microservices, Distributed Systems, MySQL, Redis, Docker, Kubernetes"><meta name="author" content="Weiguang Li"><meta name="robots" content="index, follow"><link rel="canonical" href="https://oipunk.github.io"><!-- Open Graph --><meta property="og:type" content="website"><meta property="og:url" content="https://oipunk.github.io"><meta property="og:title" content="How I Fixed a Core MCP Transport Compatibility Bug in LangChain4j"><meta property="og:description" content="Java Backend Engineer specializing in Spring Boot, distributed systems, and microservices. Explore my projects, technical blog, and expertise."><meta property="og:image" content="https://oipunk.github.io/img/og-image.jpg"><!-- Twitter Card --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:title" content="How I Fixed a Core MCP Transport Compatibility Bug in LangChain4j"><meta name="twitter:description" content="Java Backend Engineer specializing in Spring Boot, distributed systems, and microservices. Explore my projects, technical blog, and expertise."><meta name="twitter:image" content="https://oipunk.github.io/img/og-image.jpg"><link rel="shortcut icon" type="image/x-icon" href="/img/favicon.png"><link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;700&family=Inter:wght@300;400;700;900&display=swap" rel="stylesheet"><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet"><!-- Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=G-DNX03VZHBX"></script><script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-DNX03VZHBX');
    </script><link rel="stylesheet" href="/_astro/about.BWpmdKqS.css"></head> <body class="bg-gray-950 text-gray-100 font-sans"> <header class="sticky top-0 z-50 bg-gray-950/95 backdrop-blur-sm border-b border-gray-800" x-data="{ open: false, scrolled: false }" @scroll.window="scrolled = window.scrollY > 50"> <nav class="max-w-6xl mx-auto px-6 lg:px-12 py-6 flex items-center justify-between"> <a href="/" class="flex items-center gap-2 "> <i class="fas fa-code text-green-400 text-2xl led-glow"></i> <span class="text-xl font-bold font-code text-white">Weiguang Li</span> </a> <div class="hidden md:flex items-center gap-10 main-nav"> <a href="/about" class="group relative text-gray-300 hover:text-green-400 transition-colors font-medium  ">  About </a><a href="/projects" class="group relative text-gray-300 hover:text-green-400 transition-colors font-medium  ">  Projects </a><a href="/services" class="group relative text-gray-300 hover:text-green-400 transition-colors font-medium  ">  Expertise </a><a href="/blog" class="group relative text-gray-300 hover:text-green-400 transition-colors font-medium  ">  Blog </a><a href="/contact" class="group relative text-gray-300 hover:text-green-400 transition-colors font-medium  ">  Contact </a> </div> <div class="md:hidden"> <button @click="open = !open" class="text-gray-300 hover:text-green-400 transition-colors"> <i x-show="!open" style="display: none;" class="fas fa-bars text-2xl"></i> <i x-show="open" class="fas fa-times text-2xl"></i> </button> <div x-show="open" style="display: none;" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 -translate-y-2" x-transition:enter-end="opacity-100 translate-y-0" x-transition:leave="transition ease-in duration-200" x-transition:leave-start="opacity-100 translate-y-0" x-transition:leave-end="opacity-0 -translate-y-2" class="absolute top-full left-0 right-0 bg-gray-950 border-b border-gray-800 p-6 flex flex-col gap-4 shadow-lg"> <a href="/about" class="group relative text-gray-300 hover:text-green-400 transition-colors font-medium  " x-on:click="open = false">  About </a><a href="/projects" class="group relative text-gray-300 hover:text-green-400 transition-colors font-medium  " x-on:click="open = false">  Projects </a><a href="/services" class="group relative text-gray-300 hover:text-green-400 transition-colors font-medium  " x-on:click="open = false">  Expertise </a><a href="/blog" class="group relative text-gray-300 hover:text-green-400 transition-colors font-medium  " x-on:click="open = false">  Blog </a><a href="/contact" class="group relative text-gray-300 hover:text-green-400 transition-colors font-medium  " x-on:click="open = false">  Contact </a> </div> </div> </nav> </header> <main id="main" class="relative bg-gray-900/50 overflow-hidden">  <section class="py-12 max-w-6xl mx-auto px-6 lg:px-12 relative z-10"> <div class="mb-8"> <h1 class="text-3xl lg:text-4xl font-bold font-code text-white mb-2"> <span class="text-white ">How I </span><span class="text-green-500 ">Fixed a </span><span class="text-white ">Core MCP </span><span class="text-green-500 ">Transport Compatibility </span><span class="text-white ">Bug in </span><span class="text-green-500 ">LangChain4j</span> </h1> <div class="flex items-center gap-4 text-gray-400"> <i class="fas fa-calendar-alt"></i> <span>February 25, 2026</span> <span>|</span> <span>11 min read</span> </div> </div> <div class="py-8 px-6 bg-gray-950 rounded-lg border border-gray-800 mb-8"> <div class="relative mb-8"> <img src="/img/blog6.jpg" alt="How I Fixed a Core MCP Transport Compatibility Bug in LangChain4j" class="w-full object-cover rounded-lg border border-gray-800"> </div> <div class="post-content text-gray-300 space-y-8">
<h1>How I Fixed a Core MCP Transport Compatibility Bug in LangChain4j</h1>
<p>This article is a technical retrospective of one of my merged open-source contributions:</p>
<p><a href="https://github.com/langchain4j/langchain4j/pull/4584" target="_blank" rel="noopener noreferrer">langchain4j/langchain4j#4584</a> (merged into <code>main</code> on February 25, 2026).</p>
<p>The issue looked small at first, but it sat directly on a critical runtime path: MCP transport negotiation. In practice, that means real agent workflows could fail before any business logic even started.</p>

<h2>Background: Why This Problem Mattered</h2>
<p>LangChain4j's MCP integration relies on a transport layer that talks to Streamable HTTP MCP servers. The bug appeared in environments where protocol negotiation attempted an incompatible upgrade path, causing requests to hang or fail depending on server behavior.</p>
<p>This is high impact because transport failures are not isolated errors. They block the whole capability chain:</p>
<ul>
  <li>Tool discovery may never complete.</li>
  <li>Agent execution can fail during bootstrap.</li>
  <li>Failure signals are noisy, making incident triage slower.</li>
</ul>
<p>From a production engineering perspective, this is exactly the kind of issue that silently erodes trust in an AI platform.</p>

<h2>What Was Actually Broken</h2>
<p>The core symptom was protocol-level incompatibility during client-server communication for MCP streamable transport. Different servers and intermediaries do not always behave consistently around HTTP version negotiation and upgrade behavior.</p>
<p>The original path was valid in some setups but brittle across real-world deployments. In distributed systems, "works on my machine" transport behavior is not enough.</p>

<h2>Fix Strategy and Design Constraints</h2>
<p>I optimized for production safety and compatibility, not theoretical elegance. The goal was to reduce negotiation ambiguity and make transport behavior deterministic.</p>
<p>Key constraints:</p>
<ul>
  <li>Do not break existing MCP integrations.</li>
  <li>Keep API ergonomics acceptable for maintainers.</li>
  <li>Add focused tests that prove behavior, not just implementation detail.</li>
</ul>
<p>The fix centered on transport HTTP version handling in <code>StreamableHttpMcpTransport</code>, plus targeted tests around the selected client behavior.</p>

<h2>Implementation Walkthrough</h2>
<h3>1. Normalize HTTP behavior in MCP transport</h3>
<p>I updated transport construction so protocol usage is explicit and predictable rather than relying on environment-dependent negotiation behavior.</p>

<h3>2. Preserve configurability for advanced users</h3>
<p>Maintainer feedback required balancing safe defaults with explicit override capability. The final shape kept a clear, intention-revealing API while avoiding unnecessary exposure of JDK-internal HTTP types in public surface area.</p>

<h3>3. Add regression tests at the transport boundary</h3>
<p>I added tests that validate transport client version strategy directly. This ensures future refactors cannot accidentally reintroduce negotiation instability.</p>

<h2>Validation: How I Proved It</h2>
<p>I ran focused module tests locally before every push and after each review-driven change:</p>
<pre><code class="language-bash">./mvnw -pl langchain4j-mcp,langchain4j-http-client -am   -Dtest=StreamableHttpMcpTransportTest   -Dsurefire.failIfNoSpecifiedTests=false test</code></pre>
<p>I also fixed formatting gate failures (<code>spotless</code>) in the same PR cycle to keep CI clean and maintain merge velocity.</p>

<h2>Review Process and Why This PR Has High Signal</h2>
<p>This PR went through multiple rounds of maintainer feedback, including API-shape concerns and default behavior policy. The final merged result was not just "code that passes tests"; it aligned with project conventions and long-term maintainability.</p>
<p>That is exactly what makes this contribution valuable for real engineering evaluation:</p>
<ul>
  <li><strong>Scope:</strong> core runtime path, not cosmetic change.</li>
  <li><strong>Impact:</strong> improves cross-environment MCP reliability.</li>
  <li><strong>Process quality:</strong> iterative review handling, CI discipline, API design compromise.</li>
  <li><strong>Durability:</strong> regression tests encode expected behavior for future contributors.</li>
</ul>

<h2>What Problems Were Solved</h2>
<ul>
  <li>Reduced protocol negotiation fragility in Streamable HTTP MCP transport.</li>
  <li>Improved compatibility across diverse server/network setups.</li>
  <li>Lowered bootstrap failure risk for MCP-based agent workflows.</li>
  <li>Added guardrails so regressions are caught earlier by CI.</li>
</ul>

<h2>Career Value: Why This Matters Beyond One Merge</h2>
<p>For hiring and technical interviews, this is stronger evidence than a typical doc-only contribution. It demonstrates end-to-end ownership:</p>
<ol>
  <li>Problem diagnosis from runtime behavior.</li>
  <li>Minimal but robust fix in the right abstraction layer.</li>
  <li>Clear test strategy and CI closure.</li>
  <li>Collaborative iteration with maintainers until merge.</li>
</ol>
<p>If you are building your own open-source track record, prioritize issues like this: small enough to ship, deep enough to prove engineering judgment.</p>
</div> </div> <div class="p-6 bg-gray-950 rounded-lg border border-gray-800 mb-8"> <div class="flex flex-col sm:flex-row items-center gap-6"> <img src="/img/profile-avatar.png" alt="Weiguang Li" class="w-16 h-16 rounded-full object-cover"> <div> <h4 class="max-sm:text-center text-lg font-bold text-white mb-1">Weiguang Li</h4> <p class="text-gray-300 mb-3">Java Backend Engineer specializing in Spring Boot, distributed systems, and microservices. Passionate about clean code and continuous learning.</p> <div class="flex gap-4"> <a href="https://github.com/OiPunk" target="_blank" class="text-gray-300 hover:text-green-400 text-xl"> <i class="fab fa-github"></i> </a> <a href="https://linkedin.com/in/" target="_blank" class="text-gray-300 hover:text-green-400 text-xl"> <i class="fab fa-linkedin"></i> </a> <a href="https://twitter.com/" target="_blank" class="text-gray-300 hover:text-green-400 text-xl"> <i class="fab fa-twitter"></i> </a> </div> </div> </div> </div> <div class="relative"> <h3 class="text-xl font-bold font-code text-white mb-6 flex items-center gap-2"> <i class="fas fa-book text-green-400 led-glow"></i> Related Articles
</h3> <div class="grid grid-cols-1 gap-6"> <a href="/rag-production-guide" class="bg-gray-950 rounded-lg border border-gray-800 flex flex-col md:flex-row gap-4 related-card overflow-hidden transition-transform"> <img src="/img/rag-cover.svg" alt="RAG in Production: From Prototype to High-Trust AI" class="w-full md:w-1/4 object-cover"> <div class="p-6 flex-1"> <h4 class="text-lg font-bold font-code text-white mb-1">RAG in Production: From Prototype to High-Trust AI</h4> <p class="text-gray-300 text-sm">A practical, engineering-first guide to Retrieval-Augmented Generation covering architecture, chunking, hybrid retrieval, prompt grounding, and evaluation loops.</p> <div class="flex items-center gap-2 text-gray-400 text-sm mt-2"> <i class="fas fa-calendar-alt"></i> <span>February 17, 2026</span> </div> </div> </a> </div> </div> </section>  </main> <footer class="bg-dark py-16 relative overflow-hidden"> <div class="absolute inset-0 bg-hero opacity-[.03]"></div> <div class="max-w-6xl mx-auto px-6 lg:px-12 relative"> <div class="grid grid-cols-1 md:grid-cols-4 gap-12"> <div class="md:col-span-2 flex flex-col items-center md:items-start"> <a href="/" class="flex items-center gap-2 mb-4"> <i class="fas fa-code text-green-400 text-2xl led-glow"></i> <span class="text-xl font-bold font-code text-white">Weiguang Li</span> </a> <p class="text-gray-400 text-left lg:pe-16"> Java Backend Engineer specializing in Spring Boot, distributed systems, and microservices. Passionate about open source and continuous learning. </p> <div class="flex gap-4 mt-4"> <a href="https://github.com/OiPunk" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-green-400 transition-colors"> <i class="fab fa-github text-2xl"></i> </a> </div> </div> <div class="flex flex-col"> <h3 class="text-lg font-bold font-code text-white mb-4"><i class="fas fa-link text-green-400"></i> Quick Links</h3> <ul class="space-y-3"> <li> <a href="/about" class="group relative text-gray-300 hover:text-green-400 transition-colors font-medium  text-gray-400 hover:text-green-400"> <i class="fa fa-user"></i> About </a> </li><li> <a href="/projects" class="group relative text-gray-300 hover:text-green-400 transition-colors font-medium  text-gray-400 hover:text-green-400"> <i class="fa fa-code"></i> Projects </a> </li><li> <a href="/services" class="group relative text-gray-300 hover:text-green-400 transition-colors font-medium  text-gray-400 hover:text-green-400"> <i class="fa fa-cogs"></i> Expertise </a> </li><li> <a href="/blog" class="group relative text-gray-300 hover:text-green-400 transition-colors font-medium  text-gray-400 hover:text-green-400"> <i class="fa fa-blog"></i> Blog </a> </li><li> <a href="/contact" class="group relative text-gray-300 hover:text-green-400 transition-colors font-medium  text-gray-400 hover:text-green-400"> <i class="fa fa-envelope"></i> Contact </a> </li> </ul> </div> <!-- Newsletter --> <div> <h3 class="text-xl font-bold font-code text-white mb-6 flex items-center gap-2"> <i class="fas fa-envelope text-green-400"></i> Newsletter </h3> <p class="text-gray-300 mb-4">Subscribe for the latest tech articles and project updates.</p> <form class="space-y-3"> <input type="email" placeholder="Enter your email" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-gray-300 focus:outline-none focus:border-green-400 transition-colors"> <button type="submit" class="w-full px-4 py-2 bg-green-500 text-gray-900 font-bold rounded-lg hover:bg-green-600 transition-colors flex items-center justify-center gap-2"> <i class="fas fa-paper-plane"></i> Subscribe </button> </form> </div> </div> <!-- Copyright --> <div class="mt-12 pt-8 border-t border-gray-800 flex flex-col md:flex-row justify-between items-center gap-4"> <p class="text-gray-300 text-sm">
Â© 2026 Weiguang Li. Crafted with  <i class="fas fa-heart text-green-400"></i> and  <i class="fas fa-coffee text-green-400"></i>.
</p> <div class="flex gap-6 text-gray-300 text-sm"> <a href="/privacy" class="hover:text-green-400 transition-colors">Privacy Policy</a><a href="/terms" class="hover:text-green-400 transition-colors">Terms of Service</a> </div> </div> </div> </footer> <button id="back-to-top" class="fixed bottom-6 end-6 bg-gray-800 border border-green-600 font-bold size-10 flex items-center justify-center rounded-full opacity-0 invisible transition-all duration-300 z-50" style="display: none;" title="Back to Top"> <svg class="size-6 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"> <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path> </svg> </button> <script type="module" src="/_astro/Layout.astro_astro_type_script_index_0_lang.B7yG3BKd.js"></script> </body> </html>