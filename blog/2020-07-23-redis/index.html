<!DOCTYPE html><html lang="en"> <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Redis-Based Distributed Lock Implementation</title><meta name="description" content="Java Backend Engineer specializing in Spring Boot, distributed systems, and microservices. Explore my projects, technical blog, and expertise."><meta name="keywords" content="Java, Spring Boot, Backend Developer, Microservices, Distributed Systems, MySQL, Redis, Docker, Kubernetes"><meta name="author" content="Weiguang Li"><meta name="robots" content="index, follow"><link rel="canonical" href="https://oipunk.github.io"><!-- Open Graph --><meta property="og:type" content="website"><meta property="og:url" content="https://oipunk.github.io"><meta property="og:title" content="Redis-Based Distributed Lock Implementation"><meta property="og:description" content="Java Backend Engineer specializing in Spring Boot, distributed systems, and microservices. Explore my projects, technical blog, and expertise."><meta property="og:image" content="https://oipunk.github.io/img/og-image.jpg"><!-- Twitter Card --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:title" content="Redis-Based Distributed Lock Implementation"><meta name="twitter:description" content="Java Backend Engineer specializing in Spring Boot, distributed systems, and microservices. Explore my projects, technical blog, and expertise."><meta name="twitter:image" content="https://oipunk.github.io/img/og-image.jpg"><link rel="shortcut icon" type="image/x-icon" href="/img/favicon.png"><link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;700&family=Inter:wght@300;400;700;900&display=swap" rel="stylesheet"><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet"><!-- Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=G-DNX03VZHBX"></script><script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-DNX03VZHBX');
    </script><link rel="stylesheet" href="/_astro/about.Bxf0nmK-.css"></head> <body class="bg-gray-950 text-gray-100 font-sans"> <header class="sticky top-0 z-50 bg-gray-950/95 backdrop-blur-sm border-b border-gray-800" x-data="{ open: false, scrolled: false }" @scroll.window="scrolled = window.scrollY > 50"> <nav class="max-w-6xl mx-auto px-6 lg:px-12 py-6 flex items-center justify-between"> <a href="/" class="flex items-center gap-2 "> <i class="fas fa-code text-green-400 text-2xl led-glow"></i> <span class="text-xl font-bold font-code text-white">Weiguang Li</span> </a> <div class="hidden md:flex items-center gap-10 main-nav"> <a href="/about" class="group relative text-gray-300 hover:text-green-400 transition-colors font-medium  ">  About </a><a href="/projects" class="group relative text-gray-300 hover:text-green-400 transition-colors font-medium  ">  Projects </a><a href="/services" class="group relative text-gray-300 hover:text-green-400 transition-colors font-medium  ">  Expertise </a><a href="/blog" class="group relative text-gray-300 hover:text-green-400 transition-colors font-medium  ">  Blog </a><a href="/contact" class="group relative text-gray-300 hover:text-green-400 transition-colors font-medium  ">  Contact </a> </div> <div class="md:hidden"> <button @click="open = !open" class="text-gray-300 hover:text-green-400 transition-colors"> <i x-show="!open" style="display: none;" class="fas fa-bars text-2xl"></i> <i x-show="open" class="fas fa-times text-2xl"></i> </button> <div x-show="open" style="display: none;" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 -translate-y-2" x-transition:enter-end="opacity-100 translate-y-0" x-transition:leave="transition ease-in duration-200" x-transition:leave-start="opacity-100 translate-y-0" x-transition:leave-end="opacity-0 -translate-y-2" class="absolute top-full left-0 right-0 bg-gray-950 border-b border-gray-800 p-6 flex flex-col gap-4 shadow-lg"> <a href="/about" class="group relative text-gray-300 hover:text-green-400 transition-colors font-medium  " x-on:click="open = false">  About </a><a href="/projects" class="group relative text-gray-300 hover:text-green-400 transition-colors font-medium  " x-on:click="open = false">  Projects </a><a href="/services" class="group relative text-gray-300 hover:text-green-400 transition-colors font-medium  " x-on:click="open = false">  Expertise </a><a href="/blog" class="group relative text-gray-300 hover:text-green-400 transition-colors font-medium  " x-on:click="open = false">  Blog </a><a href="/contact" class="group relative text-gray-300 hover:text-green-400 transition-colors font-medium  " x-on:click="open = false">  Contact </a> </div> </div> </nav> </header> <main id="main" class="relative bg-gray-900/50 overflow-hidden">  <section class="py-12 max-w-6xl mx-auto px-6 lg:px-12 relative z-10"> <div class="mb-8"> <h1 class="text-3xl lg:text-4xl font-bold font-code text-white mb-2"> <span class="text-white ">Redis-Based Distributed </span><span class="text-green-500 ">Lock Implementation</span> </h1> <div class="flex items-center gap-4 text-gray-400"> <i class="fas fa-calendar-alt"></i> <span>July 23, 2020</span> <span>|</span> <span>11 min read</span> </div> </div> <div class="py-8 px-6 bg-gray-950 rounded-lg border border-gray-800 mb-8"> <div class="relative mb-8"> <img src="/img/blog5.jpg" alt="Redis-Based Distributed Lock Implementation" class="w-full object-cover rounded-lg border border-gray-800"> </div> <div class="post-content text-gray-300 space-y-8"><p><h2>概述</h2></p><p>为了防止分布式系统中的多个进程之间相互干扰-我们需要一种分布式协调技术来对这些进程进行调度。而这个分布式协调技术的核心就是来实现这个<strong>分布式锁</strong>。</p><p><h2>为什么要使用分布式锁</h2></p><p><img src="https:////upload-images.jianshu.io/upload_images/7986413-7cc8f57c65d81728.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/874/format/webp" alt="illustration" class="my-4" /></p><p><li>成员变量 A 存在 JVM1、JVM2、JVM3 三个 JVM 内存中</li>
<li>成员变量 A 同时都会在 JVM 分配一块内存-三个请求发过来同时对这个变量操作-显然结果是不对的</li>
<li>不是同时发过来-三个请求分别操作三个不同 JVM 内存区域的数据-变量 A 之间不存在共享-也不具有可见性-处理的结果也是不对的  </li>
  注：该成员变量 A 是一个有状态的对象</p><p>如果我们业务中确实存在这个场景的话-我们就需要一种方法解决这个问题-<strong>这就是分布式锁要解决的问题</strong></p><p><h2>分布式锁应该具备哪些条件</h2></p><p><li>在分布式系统环境下-一个方法在同一时间只能被一个机器的一个线程执行</li>
<li>高可用的获取锁与释放锁</li>
<li>高性能的获取锁与释放锁</li>
<li>具备可重入特性（可理解为重新进入-由多于一个任务并发使用-而不必担心数据错误）</li>
<li>具备锁失效机制-防止死锁</li>
<li>具备非阻塞锁特性-即没有获取到锁将直接返回获取锁失败</li></p><p><h2>分布式锁的实现有哪些</h2></p><p><li>Memcached：利用 Memcached 的 <code>add</code> 命令。此命令是原子性操作-只有在 <code>key</code> 不存在的情况下-才能 <code>add</code> 成功-也就意味着线程得到了锁。</li>
<li>Redis：和 Memcached 的方式类似-利用 Redis 的 <code>setnx</code> 命令。此命令同样是原子性操作-只有在 <code>key</code> 不存在的情况下-才能 <code>set</code> 成功。</li>
<li><strong>Zookeeper</strong>：利用 Zookeeper 的顺序临时节点-来实现分布式锁和等待队列。Zookeeper 设计的初衷-就是为了实现分布式锁服务的。</li>
<li>Chubby：Google 公司实现的粗粒度分布式锁服务-底层利用了 Paxos 一致性算法。</li></p><p><h2>通过 Redis 分布式锁的实现理解基本概念</h2></p><p>分布式锁实现的三个核心要素：</p><p><h3>加锁</h3></p><p>最简单的方法是使用 <code>setnx</code> 命令。<code>key</code> 是锁的唯一标识-按业务来决定命名。比如想要给一种商品的秒杀活动加锁-可以给 <code>key</code> 命名为 “lock_sale_商品ID” 。而 <code>value</code> 设置成什么呢？我们可以姑且设置成 <code>1</code>。加锁的伪代码如下：</p><p>``<code>plain
setnx（lock_sale_商品ID-1）
</code>`<code></p><p>当一个线程执行 </code>setnx<code> 返回 </code>1<code>-说明 </code>key<code> 原本不存在-该线程成功得到了锁；当一个线程执行 </code>setnx<code> 返回 </code>0<code>-说明 </code>key<code> 已经存在-该线程抢锁失败。</p><p><h3>解锁</h3></p><p>有加锁就得有解锁。当得到锁的线程执行完任务-需要释放锁-以便其他线程可以进入。释放锁的最简单方式是执行 </code>del<code> 指令-伪代码如下：</p><p></code>`<code>python
del（lock_sale_商品ID）
</code>`<code></p><p>释放锁之后-其他线程就可以继续执行 </code>setnx<code> 命令来获得锁。</p><p><h3>锁超时</h3></p><p>锁超时是什么意思呢？如果一个得到锁的线程在执行任务的过程中挂掉-来不及显式地释放锁-这块资源将会永远被锁住（<strong>死锁</strong>）-别的线程再也别想进来。所以-</code>setnx<code> 的 </code>key<code> 必须设置一个超时时间-以保证即使没有被显式释放-这把锁也要在一定时间后自动释放。</code>setnx<code> 不支持超时参数-所以需要额外的指令-伪代码如下：</p><p></code>`<code>plain
expire（lock_sale_商品ID- 30）
</code>`<code></p><p>综合伪代码如下：</p><p></code>`<code>csharp
if（setnx（lock_sale_商品ID-1） == 1）{    expire（lock_sale_商品ID-30）    try {        do something ......    } finally {        del（lock_sale_商品ID）    }}
</code>`<code></p><p><h3>存在什么问题</h3></p><p>以上伪代码中存在三个致命问题</p><p>#### </code>setnx<code> 和 </code>expire<code> 的非原子性</p><p>设想一个极端场景-当某线程执行 </code>setnx<code>-成功得到了锁：</p><p><img src="https:////upload-images.jianshu.io/upload_images/7986413-153ca0fbc59af246.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/470/format/webp" alt="illustration" class="my-4" /></p><p></code>setnx<code> 刚执行成功-还未来得及执行 </code>expire<code> 指令-节点 1 挂掉了。</p><p><img src="https:////upload-images.jianshu.io/upload_images/7986413-616a3d3f9f42b60d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/520/format/webp" alt="illustration" class="my-4" /></p><p>这样一来-这把锁就没有设置过期时间-变成<strong>死锁</strong>-别的线程再也无法获得锁了。</p><p>怎么解决呢？</code>setnx<code> 指令本身是不支持传入超时时间的-</code>set<code> 指令增加了可选参数-伪代码如下：</p><p></code>`<code>bash
set（lock_sale_商品ID-1-30-NX）
</code>`<code></p><p>这样就可以取代 </code>setnx<code> 指令。</p><p>#### </code>del<code> 导致误删</p><p>又是一个极端场景-假如某线程成功得到了锁-并且设置的超时时间是 30 秒。</p><p><img src="https:////upload-images.jianshu.io/upload_images/7986413-9c744a0adacf3591.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/470/format/webp" alt="illustration" class="my-4" /></p><p>如果某些原因导致线程 A 执行的很慢很慢-过了 30 秒都没执行完-这时候锁过期自动释放-线程 B 得到了锁。</p><p><img src="https:////upload-images.jianshu.io/upload_images/7986413-aff00874eea4ffb2.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/470/format/webp" alt="illustration" class="my-4" /></p><p>随后-线程 A 执行完了任务-线程 A 接着执行 </code>del<code> 指令来释放锁。但这时候线程 B 还没执行完-线程A实际上 </code>删除的是线程 B 加的锁<code>。</p><p><img src="https:////upload-images.jianshu.io/upload_images/7986413-d641463ea89da638.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/470/format/webp" alt="illustration" class="my-4" /></p><p>怎么避免这种情况呢？可以在 </code>del<code> 释放锁之前做一个判断-验证当前的锁是不是自己加的锁。至于具体的实现-可以在加锁的时候把当前的线程 ID 当做 </code>value<code>-并在删除之前验证 </code>key<code> 对应的 </code>value<code> 是不是自己线程的 ID。</p><p>加锁：</p><p></code>`<code>dart
String threadId = Thread.currentThread().getId()set（key-threadId -30-NX）
</code>`<code></p><p>解锁：</p><p></code>`<code>csharp
if（threadId .equals(redisClient.get(key))）{    del(key)}
</code>`<code></p><p>但是-这样做又隐含了一个新的问题-判断和释放锁是两个独立操作-不是原子性。</p><p>#### 出现并发的可能性</p><p>还是刚才第二点所描述的场景-虽然我们避免了线程 A 误删掉 </code>key<code> 的情况-但是同一时间有 A-B 两个线程在访问代码块-仍然是不完美的。怎么办呢？我们可以让获得锁的线程开启一个<strong>守护线程</strong>-用来给快要过期的锁“续航”。</p><p><img src="https:////upload-images.jianshu.io/upload_images/7986413-e6e284f3c6a07a85.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/470/format/webp" alt="illustration" class="my-4" /></p><p>当过去了 29 秒-线程</div> </div> <div class="p-6 bg-gray-950 rounded-lg border border-gray-800 mb-8"> <div class="flex flex-col sm:flex-row items-center gap-6"> <img src="/img/male2.jpg" alt="Weiguang Li" class="w-16 h-16 rounded-full object-cover"> <div> <h4 class="max-sm:text-center text-lg font-bold text-white mb-1">Weiguang Li</h4> <p class="text-gray-300 mb-3">Java Backend Engineer specializing in Spring Boot, distributed systems, and microservices. Passionate about clean code and continuous learning.</p> <div class="flex gap-4"> <a href="https://github.com/OiPunk" target="_blank" class="text-gray-300 hover:text-green-400 text-xl"> <i class="fab fa-github"></i> </a> <a href="https://linkedin.com/in/" target="_blank" class="text-gray-300 hover:text-green-400 text-xl"> <i class="fab fa-linkedin"></i> </a> <a href="https://twitter.com/" target="_blank" class="text-gray-300 hover:text-green-400 text-xl"> <i class="fab fa-twitter"></i> </a> </div> </div> </div> </div> <div class="relative"> <h3 class="text-xl font-bold font-code text-white mb-6 flex items-center gap-2"> <i class="fas fa-book text-green-400 led-glow"></i> Related Articles
</h3> <div class="grid grid-cols-1 gap-6"> <a href="/blog/2020-06-15-redis" class="bg-gray-950 rounded-lg border border-gray-800 flex flex-col md:flex-row gap-4 related-card overflow-hidden transition-transform"> <img src="/img/blog4.jpg" alt="Redis: Past, Present and Future" class="w-full md:w-1/4 object-cover"> <div class="p-6 flex-1"> <h4 class="text-lg font-bold font-code text-white mb-1">Redis: Past, Present and Future</h4> <p class="text-gray-300 text-sm">Evolution of data storage from files to databases to caching, with comprehensive Redis guide covering data types, persistence, and clustering.</p> <div class="flex items-center gap-2 text-gray-400 text-sm mt-2"> <i class="fas fa-calendar-alt"></i> <span>June 15, 2020</span> </div> </div> </a> </div> </div> </section>  </main> <footer class="bg-dark py-16 relative overflow-hidden"> <div class="absolute inset-0 bg-hero opacity-[.03]"></div> <div class="max-w-6xl mx-auto px-6 lg:px-12 relative"> <div class="grid grid-cols-1 md:grid-cols-4 gap-12"> <div class="md:col-span-2 flex flex-col items-center md:items-start"> <a href="/" class="flex items-center gap-2 mb-4"> <i class="fas fa-code text-green-400 text-2xl led-glow"></i> <span class="text-xl font-bold font-code text-white">Weiguang Li</span> </a> <p class="text-gray-400 text-left lg:pe-16"> Java Backend Engineer specializing in Spring Boot, distributed systems, and microservices. Passionate about open source and continuous learning. </p> <div class="flex gap-4 mt-4"> <a href="https://github.com/OiPunk" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-green-400 transition-colors"> <i class="fab fa-github text-2xl"></i> </a> </div> </div> <div class="flex flex-col"> <h3 class="text-lg font-bold font-code text-white mb-4"><i class="fas fa-link text-green-400"></i> Quick Links</h3> <ul class="space-y-3"> <li> <a href="/about" class="group relative text-gray-300 hover:text-green-400 transition-colors font-medium  text-gray-400 hover:text-green-400"> <i class="fa fa-user"></i> About </a> </li><li> <a href="/projects" class="group relative text-gray-300 hover:text-green-400 transition-colors font-medium  text-gray-400 hover:text-green-400"> <i class="fa fa-code"></i> Projects </a> </li><li> <a href="/services" class="group relative text-gray-300 hover:text-green-400 transition-colors font-medium  text-gray-400 hover:text-green-400"> <i class="fa fa-cogs"></i> Expertise </a> </li><li> <a href="/blog" class="group relative text-gray-300 hover:text-green-400 transition-colors font-medium  text-gray-400 hover:text-green-400"> <i class="fa fa-blog"></i> Blog </a> </li><li> <a href="/contact" class="group relative text-gray-300 hover:text-green-400 transition-colors font-medium  text-gray-400 hover:text-green-400"> <i class="fa fa-envelope"></i> Contact </a> </li> </ul> </div> <!-- Newsletter --> <div> <h3 class="text-xl font-bold font-code text-white mb-6 flex items-center gap-2"> <i class="fas fa-envelope text-green-400"></i> Newsletter </h3> <p class="text-gray-300 mb-4">Subscribe for the latest tech articles and project updates.</p> <form class="space-y-3"> <input type="email" placeholder="Enter your email" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-gray-300 focus:outline-none focus:border-green-400 transition-colors"> <button type="submit" class="w-full px-4 py-2 bg-green-500 text-gray-900 font-bold rounded-lg hover:bg-green-600 transition-colors flex items-center justify-center gap-2"> <i class="fas fa-paper-plane"></i> Subscribe </button> </form> </div> </div> <!-- Copyright --> <div class="mt-12 pt-8 border-t border-gray-800 flex flex-col md:flex-row justify-between items-center gap-4"> <p class="text-gray-300 text-sm">
© 2026 Weiguang Li. Crafted with  <i class="fas fa-heart text-green-400"></i> and  <i class="fas fa-coffee text-green-400"></i>.
</p> <div class="flex gap-6 text-gray-300 text-sm"> <a href="/privacy" class="hover:text-green-400 transition-colors">Privacy Policy</a><a href="/terms" class="hover:text-green-400 transition-colors">Terms of Service</a> </div> </div> </div> </footer> <button id="back-to-top" class="fixed bottom-6 end-6 bg-gray-800 border border-green-600 font-bold size-10 flex items-center justify-center rounded-full opacity-0 invisible transition-all duration-300 z-50" style="display: none;" title="Back to Top"> <svg class="size-6 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"> <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path> </svg> </button> <script type="module" src="/_astro/Layout.astro_astro_type_script_index_0_lang.B7yG3BKd.js"></script> </body> </html>